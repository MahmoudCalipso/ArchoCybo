@using MudBlazor
@using ArchoCybo.Domain.Entities.Security
@inject HttpClient Http
@inject ISnackbar Snackbar
@namespace ArchoCybo.Shared.Components

<MudDialog>
    <DialogContent>
        <MudText>Select a Git platform and repository to push your project <b>@ProjectName</b>.</MudText>
        
        <MudSelect T="GitPlatform" Label="Platform" @bind-Value="selectedPlatform" Class="mt-4">
            <MudSelectItem Value="GitPlatform.GitHub">GitHub</MudSelectItem>
            <MudSelectItem Value="GitPlatform.GitLab" Disabled="true">GitLab (Coming Soon)</MudSelectItem>
            <MudSelectItem Value="GitPlatform.Bitbucket" Disabled="true">Bitbucket (Coming Soon)</MudSelectItem>
        </MudSelect>

        @if (!isPlatformConnected)
        {
            <MudAlert Severity="Severity.Warning" Class="mt-4">
                You haven't connected your @selectedPlatform account yet.
                <MudLink href="/user/git-settings">Go to settings</MudLink>
            </MudAlert>
        }
        else
        {
            <MudTabs Elevation="0" Outlined="true" Class="mt-4">
                <MudTabPanel Text="New Repository">
                    <MudTextField @bind-Value="repoName" Label="Repository Name" Required="true" Class="mt-2" />
                    <MudTextField @bind-Value="repoDescription" Label="Description" Class="mt-2" />
                    <MudCheckBox T="bool" @bind-Value="isPrivate" Label="Private Repository" Color="Color.Primary" />
                </MudTabPanel>
                <MudTabPanel Text="Existing Repository" Disabled="true">
                    <MudText Typo="Typo.caption">Selection of existing repositories coming soon.</MudText>
                </MudTabPanel>
            </MudTabs>
        }

        @if (isPushing)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-4" />
            <MudText Typo="Typo.caption" Class="mt-1">Pushed files to @selectedPlatform...</MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@(isPushing || !isPlatformConnected)">Push to Git</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public string ProjectName { get; set; } = string.Empty;
    [Parameter] public Guid ProjectId { get; set; }

    private GitPlatform selectedPlatform = GitPlatform.GitHub;
    private bool isPlatformConnected = true; // Simplified for MVP
    private bool isPushing = false;
    private string repoName = "";
    private string repoDescription = "Generated by ArchoCybo";
    private bool isPrivate = true;

    protected override void OnInitialized()
    {
        repoName = ProjectName.Replace(" ", "-").ToLower();
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        isPushing = true;
        try
        {
            // 1. Create Repository
            var createRepoResponse = await Http.PostAsJsonAsync($"api/Git/create-repository/{selectedPlatform}", new {
                Name = repoName,
                Description = repoDescription,
                IsPrivate = isPrivate
            });

            if (createRepoResponse.IsSuccessStatusCode)
            {
                var result = await createRepoResponse.Content.ReadFromJsonAsync<dynamic>();
                Snackbar.Add($"Repository created successfully!", Severity.Success);
                
                // 2. Trigger Code Generation and Push (In a real scenario, this would be a background job)
                // For now, we simulate success
                await Task.Delay(2000); 
                
                Snackbar.Add("Code pushed to Git successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add("Failed to create repository. Check your Git token.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isPushing = false;
        }
    }
}
