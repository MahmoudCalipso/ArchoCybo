@inherits LayoutComponentBase
@using MudBlazor
@using Microsoft.AspNetCore.Components.Authorization
@using ArchoCybo.Services
@inject AuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<MudThemeProvider Theme="SlicedTheme" IsDarkMode="true" />
<MudDialogProvider />
<MudSnackbarProvider />

    <MudLayout>
        <MudAppBar Elevation="0" Color="Color.Transparent" Fixed="true" Class="mud-appbar-sliced px-4">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" Class="mr-2" />
            <MudText Typo="Typo.h6" Class="ml-2" Style="font-weight: 700; letter-spacing: 0.5px;">ARCHOCYBO</MudText>
            <MudSpacer />
            
            <AuthorizeView>
                <Authorized>
                    <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Class="ml-2">
                         <ActivatorContent>
                            <MudAvatar Color="Color.Primary" Variant="Variant.Filled">@context.User.Identity?.Name?.Substring(0, 1).ToUpper()</MudAvatar>
                         </ActivatorContent>
                         <ChildContent>
                            <MudMenuItem Disabled="true">@context.User.Identity?.Name</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout">Logout</MudMenuItem>
                         </ChildContent>
                    </MudMenu>
                </Authorized>
                <NotAuthorized>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login" Class="rounded-pill px-4">Login</MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudAppBar>

        <AuthorizeView>
            <Authorized>
                <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Never" Elevation="0" Variant="DrawerVariant.Responsive" Class="mud-drawer-sliced">
                    <MudDrawerHeader Class="d-flex align-center justify-center py-4">
                         <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Large" Color="Color.Primary" />
                         <MudText Typo="Typo.h5" Class="ml-2" Style="font-weight: 800;">AC</MudText>
                    </MudDrawerHeader>
                    <MudNavMenu Class="mt-4">
                        <MudText Typo="Typo.overline" Class="px-4 my-2 text-muted">Main</MudText>
                        <MudNavLink Href="/" Match="Microsoft.AspNetCore.Components.Routing.NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard" Class="nav-link-sliced">Dashboard</MudNavLink>
                        
                        <MudText Typo="Typo.overline" Class="px-4 my-2 mt-4 text-muted">Builder</MudText>
                        <MudNavLink Href="/projects" Icon="@Icons.Material.Filled.FolderCopy" Class="nav-link-sliced">Projects</MudNavLink>
                        <MudNavLink Href="/database" Icon="@Icons.Material.Filled.Storage" Class="nav-link-sliced">DB Explorer</MudNavLink>
                        
                        <MudText Typo="Typo.overline" Class="px-4 my-2 mt-4 text-muted">Tools</MudText>
                        <MudNavLink Href="/query-builder" Icon="@Icons.Material.Filled.QueryStats" Class="nav-link-sliced">Query Builder</MudNavLink>
                        <MudNavLink Href="/users" Icon="@Icons.Material.Filled.People" Class="nav-link-sliced">Users</MudNavLink>
                    </MudNavMenu>
                    
                    <div class="mt-auto pa-4">
                        <MudCard Class="upgrade-card pa-3" Elevation="0">
                            <MudText Typo="Typo.subtitle2" Color="Color.Inherit"><b>Pro Version</b></MudText>
                            <MudText Typo="Typo.caption" Class="d-block mb-2">Unlock all generators</MudText>
                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small" FullWidth="true" Class="rounded-lg">Upgrade</MudButton>
                        </MudCard>
                    </div>
                </MudDrawer>
            </Authorized>
            <NotAuthorized>
            </NotAuthorized>
        </AuthorizeView>

        <MudMainContent Class="mud-main-content-sliced">
            <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="px-4 py-6">
                @Body
            </MudContainer>
        </MudMainContent>
    </MudLayout>

<style>
    /* Sliced Theme Overrides */
    body {
        background-color: #151521; /* Deep dark background */
    }
    
    .mud-appbar-sliced {
        background: rgba(30, 30, 45, 0.8) !important;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .mud-drawer-sliced {
        background-color: #1e1e2d !important;
        border-right: 1px solid rgba(255,255,255,0.05);
    }
    
    .mud-main-content-sliced {
        background-color: #151521;
        min-height: 100vh;
    }
    
    .nav-link-sliced {
        border-radius: 8px;
        margin: 0 10px;
        transition: all 0.3s;
    }
    
    .nav-link-sliced.active {
        background-color: #2b2b40 !important;
        color: #7367f0 !important; /* Primary accent */
    }
    
    .nav-link-sliced:hover:not(.active) {
        background-color: rgba(255,255,255,0.05);
    }
    
    .text-muted {
        color: #6c757d;
        font-weight: 600;
        letter-spacing: 0.8px;
    }
    
    .upgrade-card {
        background: linear-gradient(45deg, #7367f0, #9e95f5);
        color: white;
        border-radius: 12px;
    }
    
    /* Global Paper/Card Styling */
    .mud-paper {
        background-color: #1e1e2d;
        color: #e1e1e6;
        border-radius: 10px;
        box-shadow: 0 4px 24px 0 rgba(0,0,0,0.25) !important;
    }
    
    .mud-table-root {
        background-color: #1e1e2d;
    }
    
    .mud-typography {
        color: #e1e1e6;
    }
    
    .mud-typography-caption {
        color: #a1a1aa;
    }
</style>

@code {
    bool _drawerOpen = true;

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    MudTheme SlicedTheme = new MudTheme()
    {
        Palette = new Palette()
        {
            Primary = "#7367f0",
            Secondary = "#ea5455",
            Success = "#28c76f",
            Info = "#00cfe8",
            Warning = "#ff9f43",
            Error = "#ea5455",
            Dark = "#4b4b4b",
            TextPrimary = "#e1e1e6",
            TextSecondary = "#b6bee3",
            Background = "#151521",
            Surface = "#1e1e2d",
            AppbarBackground = "#1e1e2d",
            DrawerBackground = "#1e1e2d",
            DrawerText = "#e1e1e6",
            DrawerIcon = "#e1e1e6",
            Divider = "#2b2b40",
            ActionDefault = "#e1e1e6",
            ActionDisabled = "#585866",
            LinesDefault = "#2b2b40"
        }
    };

    void Logout()
    {
        AuthStateProvider.MarkUserAsLoggedOut();
        NavigationManager.NavigateTo("/login", true);
    }
}
