@using MudBlazor
@using System.Net.Http.Json
@using ArchoCybo.Application.DTOs
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog>
    <DialogContent>
        <MudForm @ref="form">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField Label="Endpoint" Value="@Endpoint" Disabled="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudSelect T="Guid?" @bind-Value="SelectedPermissionId" Label="Required Permission">
                        <MudSelectItem T="Guid?" Value="@(null as Guid?)">None (public)</MudSelectItem>
                        @foreach (var p in Permissions)
                        {
                            <MudSelectItem T="Guid?" Value="@p.Id">@p.DisplayName</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12">
                    <MudSwitch @bind-Checked="IsPublic">Public</MudSwitch>
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public string Endpoint { get; set; } = string.Empty;
    [Parameter] public string Method { get; set; } = "GET";
    [Parameter] public Guid? PermissionId { get; set; }

    List<PermissionSummaryDto> Permissions = new();
    Guid? SelectedPermissionId;
    bool IsPublic = false;

    MudForm? form;

    protected override async Task OnInitializedAsync()
    {
        SelectedPermissionId = PermissionId;
        try { Permissions = await Http.GetFromJsonAsync<List<PermissionSummaryDto>>("api/Users/permissions") ?? new(); } catch { }
    }

    void Cancel() => MudDialog.Cancel();

    async Task Save()
    {
        try
        {
            var dto = new { Endpoint = Endpoint, Method = Method, PermissionId = SelectedPermissionId, IsPublic = IsPublic };
            var resp = await Http.PutAsJsonAsync($"api/admin/endpoints", dto);
            if (resp.IsSuccessStatusCode) { MudDialog.Close(DialogResult.Ok(true)); Snackbar.Add("Saved", MudBlazor.Severity.Success); }
            else { var t = await resp.Content.ReadAsStringAsync(); Snackbar.Add("Failed: " + t, MudBlazor.Severity.Error); }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error: " + ex.Message, MudBlazor.Severity.Error);
        }
    }
}
