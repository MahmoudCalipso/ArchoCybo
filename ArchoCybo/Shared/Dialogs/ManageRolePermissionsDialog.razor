@using ArchoCybo.Application.DTOs
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject ArchoCybo.Services.TokenProvider TokenProvider

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-3">Select endpoints accessible by role <b>@RoleName</b>.</MudText>
        <MudTextField @bind-Value="search" Placeholder="Search endpoints..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Class="mb-3" />
        
        <div style="max-height: 400px; overflow-y: auto;">
             <MudTable Items="FilteredEndpoints" Dense="true" Hover="true" FixedHeader="true" MultiSelection="true" @bind-SelectedItems="selectedEndpoints">
                <HeaderContent>
                    <MudTh>Method</MudTh>
                    <MudTh>Endpoint</MudTh>
                    <MudTh>Required Permission</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Method</MudTd>
                    <MudTd>@context.Endpoint</MudTd>
                    <MudTd>
                        @if (context.PermissionId.HasValue)
                        {
                            <MudChip Size="Size.Small" Color="Color.Secondary">Perm ID: @context.PermissionId.Value.ToString().Substring(0,4)...</MudChip>
                        }
                        else 
                        {
                            <MudChip Size="Size.Small">Public</MudChip>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">Save Changes</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Guid RoleId { get; set; }
    [Parameter] public required string RoleName { get; set; }

    List<EndpointAccessDto> allEndpoints = new();
    HashSet<EndpointAccessDto> selectedEndpoints = new();
    List<PermissionSummaryDto> rolePermissions = new();
    string search = "";

    IEnumerable<EndpointAccessDto> FilteredEndpoints => allEndpoints.Where(e => 
        string.IsNullOrEmpty(search) || 
        e.Endpoint.Contains(search, StringComparison.OrdinalIgnoreCase) || 
        e.Method.Contains(search, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        AttachToken();
        await LoadData();
    }

    void AttachToken()
    {
         if (!string.IsNullOrEmpty(TokenProvider.Token))
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", TokenProvider.Token);
    }

    async Task LoadData()
    {
        try 
        {
            // Load all endpoints
            allEndpoints = await Http.GetFromJsonAsync<List<EndpointAccessDto>>("api/Users/endpoints/all") ?? new();
            
            // Load current role permissions
            rolePermissions = await Http.GetFromJsonAsync<List<PermissionSummaryDto>>($"api/Users/roles/{RoleId}/permissions") ?? new();
            var rolePermIds = rolePermissions.Select(p => p.Id).ToHashSet();

            // Pre-select endpoints where the role has the required permission
            foreach(var ep in allEndpoints)
            {
                if (ep.PermissionId.HasValue && rolePermIds.Contains(ep.PermissionId.Value))
                {
                    selectedEndpoints.Add(ep);
                }
            }
        }
        catch(Exception ex)
        {
            Snackbar.Add("Error loading data: " + ex.Message, Severity.Error);
        }
    }

    void Cancel() => MudDialog.Cancel();

    async Task Submit()
    {
        // Calculate which permissions are selected
        // We gather all PermissionIds from the selected endpoints
        var selectedPermissionIds = selectedEndpoints
            .Where(e => e.PermissionId.HasValue)
            .Select(e => e.PermissionId!.Value)
            .Distinct()
            .ToList();

        try
        {
            var resp = await Http.PutAsJsonAsync($"api/Users/roles/{RoleId}/permissions", selectedPermissionIds);
            if (resp.IsSuccessStatusCode)
            {
                Snackbar.Add("Permissions updated successfully", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add("Failed to update permissions", Severity.Error);
            }
        }
        catch(Exception ex)
        {
            Snackbar.Add("Error saving: " + ex.Message, Severity.Error);
        }
    }
}
