@page "/register"
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraSmall" Style="margin-top: 60px;">
    <MudPaper Class="pa-6" Elevation="4">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">ArchoCybo</MudText>
        <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-6">Create Your Account</MudText>

        <MudTextField @bind-Value="fullName" Label="Full Name" Variant="Variant.Outlined" Class="mb-4" />
        <MudTextField @bind-Value="email" Label="Email" Variant="Variant.Outlined" InputType="InputType.Email" Class="mb-4" />
        <MudTextField @bind-Value="username" Label="Username" Variant="Variant.Outlined" Class="mb-4" />
        <MudTextField @bind-Value="password" Label="Password" Variant="Variant.Outlined" InputType="InputType.Password" Class="mb-2" />
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-4">Minimum 8 characters</MudText>

        <MudTextField @bind-Value="confirmPassword" Label="Confirm Password" Variant="Variant.Outlined" InputType="InputType.Password" Class="mb-4" />

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
        }

        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="OnRegister" Disabled="isLoading">
            @if (isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                <span>Create Account</span>
            }
        </MudButton>

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-3">
            Already have an account? <MudLink Href="/login">Sign In</MudLink>
        </MudText>

        <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">
            By registering, you agree to our Terms of Service
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    string fullName = string.Empty;
    string email = string.Empty;
    string username = string.Empty;
    string password = string.Empty;
    string confirmPassword = string.Empty;
    string errorMessage = string.Empty;
    bool isLoading = false;

    async Task OnRegister()
    {
        errorMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(fullName) || string.IsNullOrWhiteSpace(email) ||
            string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "All fields are required";
            return;
        }

        if (password.Length < 8)
        {
            errorMessage = "Password must be at least 8 characters";
            return;
        }

        if (password != confirmPassword)
        {
            errorMessage = "Passwords do not match";
            return;
        }

        isLoading = true;

        try
        {
            var registerDto = new
            {
                FullName = fullName,
                Email = email,
                Username = username,
                Password = password
            };

            var resp = await Http.PostAsJsonAsync("api/auth/register", registerDto);

            if (resp.IsSuccessStatusCode)
            {
                Snackbar.Add("Account created successfully! Redirecting to login...", Severity.Success);
                await Task.Delay(1500);
                Nav.NavigateTo("/login", true);
            }
            else
            {
                var errorContent = await resp.Content.ReadAsStringAsync();
                errorMessage = errorContent.Contains("already exists")
                    ? "Email or username already exists"
                    : "Registration failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Connection error. Please try again.";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }
}
