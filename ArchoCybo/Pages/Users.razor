@page "/users"
@attribute [Authorize]
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@using ArchoCybo.Shared
@using MudBlazor
@using MudBlazor.Services
@using ArchoCybo.Application.DTOs
@using System.Text.Json
@using ArchoCybo.Services
@using static MudBlazor.CategoryTypes
@using Microsoft.AspNetCore.Authorization
@inject HttpClient Http
@inject NavigationManager Nav
@inject TokenProvider TokenProvider
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large">
  <MudText Typo="Typo.h4">Users</MudText>

  <MudPaper Class="pa-4 mt-3">
    <MudTable Items="users?.Items" Dense="true" Hover="true">
      <ToolBarContent>
        <MudText Typo="Typo.subtitle1">User Management</MudText>
        <MudSpacer />
                <MudTextField @bind-Value="search"
                              Placeholder="Search..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="Icons.Material.Filled.Search"
                              Immediate="true"
                              OnInput="RefreshUsers" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreate">New User</MudButton>
      </ToolBarContent>
      <HeaderContent>
        <MudTh>Username</MudTh>
        <MudTh>Email</MudTh>
        <MudTh>Active</MudTh>
        <MudTh></MudTh>
      </HeaderContent>
      <RowTemplate Context="user">
        <MudTd>@user.Username</MudTd>
        <MudTd>@user.Email</MudTd>
        <MudTd>@user.IsActive</MudTd>
        <MudTd>
          <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="() => EditUser(user)">Edit</MudButton>
          <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Error" Class="ml-2" OnClick="() => ConfirmDelete(user.Id)">Delete</MudButton>
        </MudTd>
      </RowTemplate>
    </MudTable>

    <MudStack Direction="Row"
              AlignItems="AlignItems.Center"
              Justify="Justify.SpaceBetween"
              Class="mt-2">
      <MudText Typo="Typo.caption">Showing @(((users?.Page ?? 1 -1)* (users?.PageSize ?? 10))+1)-@((((users?.Page ?? 1)-1)*(users?.PageSize ?? 10))+ (users?.Items.Count() ?? 0)) of @users?.TotalCount</MudText>
      <MudStack Direction="Row" Spacing="1">
        <MudButton Disabled="@(users==null || users.Page==1)" OnClick="PreviousUsers">Previous</MudButton>
        <MudButton Disabled="@(users==null || (users.Page*users.PageSize>=users.TotalCount))" OnClick="NextUsers">Next</MudButton>
      </MudStack>
    </MudStack>
  </MudPaper>
</MudContainer>

@code {
  string search = string.Empty;
  PagedResult<UserListItem>? users;

  protected override async Task OnInitializedAsync()
  {
    await LoadUsers();
  }

  async Task LoadUsers(int page = 1)
  {
    try
    {
      AttachTokenIfNeeded();
      users = await Http.GetFromJsonAsync<PagedResult<UserListItem>>(Nav.ToAbsoluteUri($"api/users?page={page}&pageSize=10&q={Uri.EscapeDataString(search)}"));
    }
    catch (Exception ex)
    {
      Snackbar.Add("Failed to load users: " + ex.Message, MudBlazor.Severity.Error);
      users = new PagedResult<UserListItem>(Enumerable.Empty<UserListItem>(), 0, 1, 10);
    }
  }

  void AttachTokenIfNeeded()
  {
    if (!string.IsNullOrEmpty(TokenProvider.Token)) Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", TokenProvider.Token);
    else Http.DefaultRequestHeaders.Authorization = null;
  }

  void OpenCreate()
  {
    var options = new MudBlazor.DialogOptions { CloseButton = true, MaxWidth = MudBlazor.MaxWidth.Small };
    var parameters = new MudBlazor.DialogParameters { { "Model", new CreateUserModel() } };
    var dlg = DialogService.Show<Shared.Dialogs.CreateEditProjectDialog>("New User", parameters, options);
    _ = dlg.Result.ContinueWith(async t => { if (!t.IsFaulted && t.Result.Data is true) await LoadUsers(); });
  }

  void EditUser(UserListItem u)
  {
    var parameters = new MudBlazor.DialogParameters { { "Model", new UserEditModel { Id = u.Id, Email = u.Email, IsActive = u.IsActive } } };
    var dlg = DialogService.Show<Shared.Dialogs.CreateEditProjectDialog>("Edit User", parameters);
  }

  async Task CreateUser()
  {
    try
    {
      AttachTokenIfNeeded();
      var dto = new { Username = "", Email = "", Password = "" };
      var resp = await Http.PostAsJsonAsync(Nav.ToAbsoluteUri("api/users"), dto);
    }
    catch { }
  }

  async Task ConfirmDelete(Guid id)
  {
    var parameters = new MudBlazor.DialogParameters { { "ContentText", $"Are you sure you want to delete this user?" }, { "ButtonText", "Delete" }, { "Color", MudBlazor.Color.Error } };
    var options = new MudBlazor.DialogOptions { CloseButton = true };
    var dlg = DialogService.Show<DialogConfirm>("Confirm", parameters, options);
    var result = await dlg.Result;
    if (!result.Cancelled)
    {
      await DeleteUser(id);
    }
  }

  async Task DeleteUser(Guid id)
  {
    try
    {
      AttachTokenIfNeeded();
      var resp = await Http.DeleteAsync(Nav.ToAbsoluteUri($"api/users/{id}"));
      if (resp.IsSuccessStatusCode)
      {
        Snackbar.Add("User deleted", MudBlazor.Severity.Success);
        await LoadUsers(users?.Page ?? 1);
      }
    }
    catch (Exception ex)
    {
      Snackbar.Add("Error deleting user: " + ex.Message, MudBlazor.Severity.Error);
    }
  }

  void PreviousUsers()
  {
    if (users != null && users.Page > 1) _ = LoadUsers(users.Page - 1);
  }

  void NextUsers()
  {
    if (users != null && (users.Page * users.PageSize < users.TotalCount)) _ = LoadUsers(users.Page + 1);
  }

  // Models
  public class UserListItem
  {
    public Guid Id { get; set; }
    public string Username { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public bool IsActive { get; set; }
  }

  public class CreateUserModel
  {
    [Required]
    public string Username { get; set; } = string.Empty;
    [Required]
    public string Email { get; set; } = string.Empty;
    [Required]
    public string Password { get; set; } = string.Empty;
  }

  public class UserEditModel
  {
    public Guid Id { get; set; }
    public string Email { get; set; } = string.Empty;
    public bool IsActive { get; set; }
  }
}
