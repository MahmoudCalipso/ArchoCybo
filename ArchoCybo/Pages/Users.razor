@page "/users"
@attribute [Authorize]
@using System.Net.Http.Json
@using ArchoCybo.Application.DTOs
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Nav
@inject ArchoCybo.Services.TokenProvider TokenProvider

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
        <MudText Typo="Typo.h4">Users</MudText>
        <MudTextField T="string" Label="Search" Value="@search" ValueChanged="@OnSearchChanged" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" />
    </MudStack>

    <MudPaper Class="pa-4" Elevation="3">
        <MudTable Items="users" Hover="true" Dense="true">
            <HeaderContent>
                <MudTh>Username</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Active</MudTh>
                <MudTh>Roles</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Username">@context.Username</MudTd>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Active">@context.IsActive</MudTd>
                <MudTd DataLabel="Roles">@string.Join(", ", context.Roles)</MudTd>
                <MudTd DataLabel="Actions">
                    <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => EditDetails(context))">Edit Details</MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="@(() => EditRoles(context))">Roles</MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Info" OnClick="@(() => EditPermissions(context))">Permissions</MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Tertiary" OnClick="@(() => ViewEndpoints(context))">Endpoints</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>

        <MudTablePager PageSizeOptions="new int[]{10,20,50}" PageSize="pageSize" PageIndex="page-1" OnPageChanged="OnPageChanged" OnPageSizeChanged="OnPageSizeChanged" />
    </MudPaper>
    
    @if (endpointsForUser != null)
    {
        <MudPaper Class="pa-3 mt-3" Elevation="2">
            <MudText Typo="Typo.h6">Endpoint Access</MudText>
            <MudTable Items="endpointsForUser">
                <HeaderContent>
                    <MudTh>Method</MudTh>
                    <MudTh>Path</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh>Has Access</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Method</MudTd>
                    <MudTd>@context.Endpoint</MudTd>
                    <MudTd>@context.Description</MudTd>
                    <MudTd>@(context.HasAccess ? "Yes" : "No")</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

@code {
    List<UserListData> users = new();
    int page = 1;
    int pageSize = 20;
    string search = "";
    Guid? selectedUserId;
    List<EndpointAccessDto>? endpointsForUser;
    List<RoleSummaryDto> allRoles = new();
    List<PermissionSummaryDto> allPermissions = new();

    protected override async Task OnInitializedAsync()
    {
        AttachToken();
        await LoadRoles();
        await LoadPermissions();
        await LoadUsers();
    }

    void AttachToken()
    {
        if (!string.IsNullOrEmpty(TokenProvider.Token))
            Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", TokenProvider.Token);
    }
    
    async Task LoadUsers()
    {
        var resp = await Http.GetFromJsonAsync<PagedResult<UserListData>>($"api/Users?page={page}&pageSize={pageSize}&q={search}");
        users = resp?.Items.ToList() ?? new();
    }

    async Task LoadRoles()
    {
        allRoles = await Http.GetFromJsonAsync<List<RoleSummaryDto>>("api/Users/roles") ?? new();
    }

    async Task LoadPermissions()
    {
        allPermissions = await Http.GetFromJsonAsync<List<PermissionSummaryDto>>("api/Users/permissions") ?? new();
    }

    void OnPageChanged(int newPage) { page = newPage + 1; _ = LoadUsers(); }
    void OnPageSizeChanged(int newSize) { pageSize = newSize; _ = LoadUsers(); }
    void OnSearchChanged(string s) { search = s ?? ""; _ = LoadUsers(); }

    async Task EditDetails(UserListData u)
    {
        var dto = new UpdateUserDetailsDto { Email = u.Email, Username = u.Username, IsActive = u.IsActive };
        var result = await DialogService.Show<ArchoCybo.Shared.Dialogs.PromptDialog>("Confirm", new DialogParameters { { "ContentText", $"Update details for {u.Username}?" }, { "ButtonText", "Update" }, { "Color", Color.Primary } }).Result;
        if (!result.Cancelled)
        {
            var ok = await Http.PutAsJsonAsync($"api/Users/{u.Id}/details", dto);
            if (ok.IsSuccessStatusCode) { Snackbar.Add("Updated user details", Severity.Success); await LoadUsers(); }
            else { Snackbar.Add("Failed to update", Severity.Error); }
        }
    }

    async Task EditRoles(UserListData u)
    {
        selectedUserId = u.Id;
        var roleIds = allRoles.Where(r => u.Roles.Contains(r.Name)).Select(r => r.Id).ToList();
        var parameters = new DialogParameters { { "AllRoles", allRoles }, { "SelectedRoleIds", roleIds } };
        var dialog = DialogService.Show<ArchoCybo.Shared.Dialogs.EditUserRolesDialog>("Edit Roles", parameters);
        var result = await dialog.Result;
        if (!result.Cancelled && result.Data is List<Guid> selected)
        {
            var ok = await Http.PutAsJsonAsync($"api/Users/{u.Id}/roles", selected);
            if (ok.IsSuccessStatusCode) { Snackbar.Add("Updated roles", Severity.Success); await LoadUsers(); }
            else { Snackbar.Add("Failed to update roles", Severity.Error); }
        }
    }

    async Task EditPermissions(UserListData u)
    {
        selectedUserId = u.Id;
        var selectedPermIds = allPermissions.Where(p => u.Permissions.Contains(p.Name)).Select(p => p.Id).ToList();
        var parameters = new DialogParameters { { "AllPermissions", allPermissions }, { "SelectedPermissionIds", selectedPermIds } };
        var dialog = DialogService.Show<ArchoCybo.Shared.Dialogs.EditUserPermissionsDialog>("Edit Permissions", parameters);
        var result = await dialog.Result;
        if (!result.Cancelled && result.Data is List<Guid> selected)
        {
            var dto = new UpdateUserPermissionsDto { UserId = u.Id, AllowedPermissionIds = selected };
            var ok = await Http.PutAsJsonAsync($"api/Users/{u.Id}/permissions", dto);
            if (ok.IsSuccessStatusCode) { Snackbar.Add("Updated permissions", Severity.Success); await LoadUsers(); }
            else { Snackbar.Add("Failed to update permissions", Severity.Error); }
        }
    }

    async Task ViewEndpoints(UserListData u)
    {
        selectedUserId = u.Id;
        endpointsForUser = await Http.GetFromJsonAsync<List<EndpointAccessDto>>($"api/Users/{u.Id}/endpoints") ?? new();
    }
}
