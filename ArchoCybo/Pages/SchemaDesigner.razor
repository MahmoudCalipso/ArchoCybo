@page "/project/{ProjectId}/schema"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using ArchoCybo.Application.DTOs
@using ArchoCybo.Shared.Dialogs
@inject HttpClient Http
@inject IDialogService DialogService
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.SignalR.Client.HubConnection? Hub

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4" Style="height: 85vh; display: flex; flex-direction: column;">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
        <MudText Typo="Typo.h4" Style="font-weight: 700; color: #d1d5db;">Schema Designer</MudText>
        <MudStack Direction="Row">
             <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Code" OnClick="GoToQueryBuilder">Query Builder</MudButton>
             <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="AddEntity" Class="rounded-lg">Add Entity</MudButton>
        </MudStack>
    </MudStack>

    <!-- Canvas Area -->
    <div class="schema-canvas" style="flex-grow: 1; background-color: #0f111a; position: relative; overflow: auto; border-radius: 12px; border: 1px solid #2d2d3b; background-image: radial-gradient(#2d2d3b 1px, transparent 1px); background-size: 24px 24px;">
        
        <!-- SVG Layer for Relations -->
        <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280" />
                </marker>
            </defs>
            @foreach (var rel in relationsToDraw)
            {
                <path d="@GetPath(rel)" stroke="#6b7280" stroke-width="2" fill="none" marker-end="url(#arrowhead)" />
            }
        </svg>

        @foreach (var node in entityNodes)
        {
            <MudPaper Class="schema-node" Elevation="6" Style="@($"position: absolute; left: {node.X}px; top: {node.Y}px; width: 260px; cursor: move; z-index: 1; border-radius: 8px; border: 1px solid #374151; background-color: #1f2937;")" @onclick="() => EditEntity(node.Entity!)">
                <!-- Header -->
                <div class="d-flex justify-space-between align-center px-4 py-3" style="background: linear-gradient(to right, #7e22ce, #a855f7); color: white; border-top-left-radius: 8px; border-top-right-radius: 8px;">
                    <MudText Typo="Typo.h6" Style="font-size: 1rem; font-weight: 600;">@node.Entity!.Name</MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Color="Color.Inherit" />
                </div>
                
                <!-- Fields -->
                <div class="px-4 py-3">
                    @if (node.Entity!.Fields != null)
                    {
                        @foreach (var field in node.Entity.Fields.Take(5))
                        {
                            <div class="d-flex justify-space-between align-center mb-1" style="border-bottom: 1px solid #374151; padding-bottom: 4px;">
                                <MudText Typo="Typo.body2" Style="color: #e5e7eb;">@field.Name</MudText>
                                <MudText Typo="Typo.caption" Style="color: #9ca3af; font-family: monospace;">@field.DataType</MudText>
                            </div>
                        }
                        @if (node.Entity.Fields.Count > 5)
                        {
                            <MudText Typo="Typo.caption" Align="Align.Center" Class="d-block mt-2" Style="color: #9ca3af;">+ @(node.Entity.Fields.Count - 5) more columns</MudText>
                        }
                    }
                </div>
            </MudPaper>
        }
    </div>
</MudContainer>

@code {
    [Parameter] public required string ProjectId { get; set; }
    
    class EntityNode
    {
        public EntityDto? Entity { get; set; }
        public double X { get; set; }
        public double Y { get; set; }
    }
    
    class RelationDraw
    {
        public double X1 { get; set; }
        public double Y1 { get; set; }
        public double X2 { get; set; }
        public double Y2 { get; set; }
    }

    List<EntityNode> entityNodes = new();
    List<RelationDraw> relationsToDraw = new();
    private HubConnection? hub;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntities();
        
        // SignalR
        hub = new Microsoft.AspNetCore.SignalR.Client.HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/hubs/notifications"))
            .WithAutomaticReconnect()
            .Build();

        hub.On<Guid>("ProjectUpdated", async (Guid id) =>
        {
            if (id.ToString() == ProjectId)
            {
                await LoadEntities();
                StateHasChanged();
            }
        });

        try { await hub.StartAsync(); } catch {}
    }

    async Task LoadEntities()
    {
        try
        {
            var dtos = await Http.GetFromJsonAsync<List<EntityDto>>($"api/projects/{ProjectId}/entities") ?? new();
            
            // Layout logic
            entityNodes.Clear();
            int x = 60, y = 60, col = 0;
            foreach (var e in dtos)
            {
                entityNodes.Add(new EntityNode { Entity = e, X = x, Y = y });
                
                x += 320;
                col++;
                if (col > 3) { col = 0; x = 60; y += 350; }
            }
            
            CalculateRelations();
        }
        catch (Exception ex)
        {
            // log
        }
    }
    
    void CalculateRelations()
    {
        relationsToDraw.Clear();
        foreach (var node in entityNodes)
        {
            if (node.Entity?.Relations == null) continue;
            
            foreach (var rel in node.Entity.Relations)
            {
                var target = entityNodes.FirstOrDefault(n => n.Entity?.Id == rel.TargetEntityId);
                if (target != null)
                {
                    // Center of nodes (width 260)
                    relationsToDraw.Add(new RelationDraw 
                    { 
                        X1 = node.X + 130, Y1 = node.Y + 40, // rough center
                        X2 = target.X + 130, Y2 = target.Y + 40 
                    });
                }
            }
        }
    }
    
    string GetPath(RelationDraw r)
    {
        // Curvi-linear connector
        var mx = (r.X1 + r.X2) / 2;
        var my = (r.Y1 + r.Y2) / 2;
        
        // Horizontal logic
        return $"M {r.X1} {r.Y1} C {r.X1 + 50} {r.Y1}, {r.X2 - 50} {r.Y2}, {r.X2} {r.Y2}";
    }

    async Task AddEntity()
    {
        var parameters = new DialogParameters { { "ProjectId", ProjectId } };
        var dialog = DialogService.Show<AddEntityDialog>("Add Entity", parameters);
        var result = await dialog.Result;
        
        if (!result.Cancelled && result.Data != null)
        {
             // Actually create via API
             dynamic data = result.Data;
             var dto = new CreateEntityDto(data.EntityName, data.EntityName); // simplified
             await Http.PostAsJsonAsync($"api/projects/{ProjectId}/entities", dto);
             // SignalR will refresh
        }
    }
    
    void EditEntity(EntityDto entity)
    {
        var parameters = new DialogParameters 
        { 
            { "EntityName", entity.Name },
            { "EntityId", entity.Id.ToString() },
            { "ProjectId", ProjectId }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<EditEntityDialog>("Manage Entity", parameters, options);
    }
    
    void GoToQueryBuilder()
    {
        Nav.NavigateTo($"/query-builder/{ProjectId}");
    }
    
    public async ValueTask DisposeAsync()
    {
        if (hub != null) try { await hub.DisposeAsync(); } catch { }
    }
}
