@page "/my-projects"
@attribute [Authorize]
@using System.Net.Http.Json
@using System.Text.Json
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Authorization
@using ArchoCybo.Services
@inject HttpClient Http
@inject NavigationManager Nav
@inject TokenProvider TokenProvider
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4">My Projects</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateProjectDialog">
            New Project
        </MudButton>
    </MudStack>

    @if (projects != null && projects.Count > 0)
    {
        <MudGrid>
            @foreach (var project in projects)
            {
                var projectId = project.GetProperty("id").GetString();
                var projectName = project.GetProperty("name").GetString();
                var description = project.GetProperty("description").GetString();
                var status = project.GetProperty("status").GetString();
                var createdAt = project.GetProperty("created_at").GetDateTime();

                <MudItem xs="12" md="4">
                    <MudCard Class="h-100">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@projectName</MudText>
                                <MudChip Size="Size.Small" Color="GetStatusColor(status)">@status</MudChip>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                                @description
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Tertiary">
                                Created: @createdAt.ToShortDateString()
                            </MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" Size="Size.Small" Href="@($"/project/{projectId}")">
                                Open
                            </MudButton>
                            <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="() => DownloadProject(projectId)">
                                Download
                            </MudButton>
                            <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Error" OnClick="() => DeleteProject(projectId, projectName)">
                                Delete
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudPaper Class="pa-8" Elevation="2" Style="text-align:center;">
            <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" Color="Color.Default" Class="mb-3" />
            <MudText Typo="Typo.h6" Color="Color.Default">No Projects Yet</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">Create your first backend project to get started</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenCreateProjectDialog">
                Create Project
            </MudButton>
        </MudPaper>
    }
</MudContainer>

@code {
    List<JsonElement>? projects;

    protected override async Task OnInitializedAsync()
    {
        AttachToken();
        await LoadProjects();
    }

    void AttachToken()
    {
        if (!string.IsNullOrEmpty(TokenProvider.Token))
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenProvider.Token);
    }

    async Task LoadProjects()
    {
        try
        {
            projects = await Http.GetFromJsonAsync<List<JsonElement>>(Nav.ToAbsoluteUri("api/projects"));
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load projects: " + ex.Message, Severity.Error);
        }
    }

    void OpenCreateProjectDialog()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = DialogService.Show<Dialogs.CreateProjectDialog>("Create New Project", parameters, options);
    }

    async Task DownloadProject(string? projectId)
    {
        if (string.IsNullOrEmpty(projectId)) return;

        try
        {
            AttachToken();
            var resp = await Http.PostAsync(Nav.ToAbsoluteUri($"api/projects/{projectId}/generate"), null);

            if (resp.IsSuccessStatusCode)
            {
                var content = await resp.Content.ReadAsByteArrayAsync();
                var fileName = $"project-backend.zip";

                await using var stream = new MemoryStream(content);
                var streamRef = new DotNetStreamReference(stream);
                await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);

                Snackbar.Add("Project downloaded successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to generate project", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error: " + ex.Message, Severity.Error);
        }
    }

    async Task DeleteProject(string? projectId, string? projectName)
    {
        if (string.IsNullOrEmpty(projectId)) return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Delete '{projectName}'? This cannot be undone.");
        if (!confirmed) return;

        try
        {
            AttachToken();
            var resp = await Http.DeleteAsync(Nav.ToAbsoluteUri($"api/projects/{projectId}"));

            if (resp.IsSuccessStatusCode)
            {
                Snackbar.Add("Project deleted successfully", Severity.Success);
                await LoadProjects();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error: " + ex.Message, Severity.Error);
        }
    }

    Color GetStatusColor(string? status)
    {
        return status switch
        {
            "Draft" => Color.Default,
            "Ready" => Color.Success,
            "Generated" => Color.Info,
            _ => Color.Default
        };
    }

    [Inject] IJSRuntime? JS { get; set; }
}
