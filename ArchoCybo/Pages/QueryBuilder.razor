@page "/query-builder/{ProjectId?}"
@page "/query-builder/{ProjectId}/{QueryId?}"
@attribute [Authorize]
@using System.Net.Http.Json
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.SignalR.Client
@using System.Text.Json
@using ArchoCybo.Application.DTOs
@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Visual Query Builder</MudText>

    @if (string.IsNullOrEmpty(ProjectId))
    {
        <MudAlert Severity="Severity.Warning">Please select a project to build queries.</MudAlert>
    }
    else
    {
        <MudGrid>
            <!-- Left Panel: Tables & Fields -->
            <MudItem xs="12" md="3">
                <MudPaper Class="pa-4" Elevation="3" Height="100%">
                    <MudText Typo="Typo.h6" Class="mb-2">Tables</MudText>
                    <MudSelect T="string" Label="Main Table" Value="@state.MainTable" ValueChanged="@OnMainTableChanged" Variant="Variant.Outlined" Dense="true">
                        @foreach (var e in entities)
                        {
                            <MudSelectItem Value="@e.Name">@e.Name</MudSelectItem>
                        }
                    </MudSelect>

                    @if (!string.IsNullOrEmpty(state.MainTable))
                    {
                        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Columns (@state.MainTable)</MudText>
                        <MudList T="string" Dense="true" Clickable="true" Style="max-height: 240px; overflow-y: auto;">
                            <MudListItem>
                                <MudCheckBox T="bool" Label="(Select All)" Checked="@IsAllSelected" CheckedChanged="@OnSelectAllChanged" Dense="true" Color="Color.Primary" />
                            </MudListItem>
                            @foreach (var f in GetFields(state.MainTable))
                            {
                                var qn = $"{state.MainTable}.{f.Name}";
                                <MudListItem>
                                    <MudCheckBox T="bool" Label="@f.Name" Checked="@state.SelectedFields.Contains(qn)" CheckedChanged="@((v) => OnFieldCheck(qn, v))" Dense="true" Color="Color.Primary" />
                                </MudListItem>
                            }
                        </MudList>

                        @if (state.Joins.Any(j => !string.IsNullOrEmpty(j.Table)))
                        {
                            <MudDivider Class="my-3" />
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Joined Tables</MudText>
                            @foreach (var j in state.Joins.Where(j => !string.IsNullOrEmpty(j.Table)))
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="@j.Table">
                                        <MudList T="string" Dense="true" Clickable="true" Style="max-height: 200px; overflow-y: auto;">
                                            @foreach (var f in GetFields(j.Table))
                                            {
                                                var qn2 = $"{j.Table}.{f.Name}";
                                                <MudListItem>
                                                    <MudCheckBox T="bool" Label="@f.Name" Checked="@state.SelectedFields.Contains(qn2)" CheckedChanged="@((v) => OnFieldCheck(qn2, v))" Dense="true" Color="Color.Primary" />
                                                </MudListItem>
                                            }
                                        </MudList>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }
                        }
                    }
                </MudPaper>
            </MudItem>

            <!-- Middle Panel: Builder UI -->
            <MudItem xs="12" md="5">
                <MudStack Spacing="3">
                    <!-- Joins Section -->
                    <MudPaper Class="pa-4" Elevation="3">
                        <MudStack Direction="Row" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.h6">Relationships (Joins)</MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="AddJoin" />
                        </MudStack>
                        
                        @foreach (var join in state.Joins)
                        {
                            <MudPaper Class="pa-3 mt-2" Outlined="true" Style="background-color: var(--mud-palette-background-grey);">
                                <MudGrid Class="align-center">
                                    <MudItem xs="3">
                                        <MudSelect T="string" @bind-Value="join.Type" Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined">
                                            <MudSelectItem Value="@("INNER")">Inner</MudSelectItem>
                                            <MudSelectItem Value="@("LEFT")">Left</MudSelectItem>
                                            <MudSelectItem Value="@("RIGHT")">Right</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="4">
                                        <MudSelect T="string" Value="@join.Table" ValueChanged="@((v) => { join.Table = v; UpdateQueryText(); })" Label="Table" Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined">
                                            @foreach (var e in entities)
                                            {
                                                <MudSelectItem Value="@e.Name">@e.Name</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="1">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="() => RemoveJoin(join)" />
                                    </MudItem>
                                </MudGrid>
                                <MudGrid Class="mt-1">
                                    <MudItem xs="5">
                                        <MudAutocomplete T="string" Value="@join.OnLeft" ValueChanged="@((v) => { join.OnLeft = v; UpdateQueryText(); })" Label="Left Field" SearchFunc="@SearchFields" Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined" Placeholder="Main.Id" CoerceText="true" />
                                    </MudItem>
                                    <MudItem xs="2" Class="d-flex justify-center align-center">
                                        <MudText>=</MudText>
                                    </MudItem>
                                    <MudItem xs="5">
                                        <MudAutocomplete T="string" Value="@join.OnRight" ValueChanged="@((v) => { join.OnRight = v; UpdateQueryText(); })" Label="Right Field" SearchFunc="@((v) => SearchSpecificTableFields(join.Table, v))" Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined" Placeholder="Join.RefId" CoerceText="true" />
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        }
                    </MudPaper>

                    <!-- Filters Section -->
                    <MudPaper Class="pa-4" Elevation="3">
                        <MudStack Direction="Row" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.h6">Filters</MudText>
                        </MudStack>
                        
                        <MudPaper Class="pa-2" Outlined="true">
                            @RenderFilterGroup(state.RootFilterGroup)
                        </MudPaper>
                    </MudPaper>
                </MudStack>
            </MudItem>

            <!-- Right Panel: Result Code -->
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="3" Height="100%">
                    <MudText Typo="Typo.h6" Class="mb-2">Generated Code</MudText>
                    
                    <MudSelect T="string" Label="Output Style" Value="@targetStyle" ValueChanged="@OnStyleChanged" Variant="Variant.Outlined" Class="mb-4">
                        <MudSelectItem Value="@("SQL")">SQL</MudSelectItem>
                        <MudSelectItem Value="@("MongoDB")">MongoDB Shell</MudSelectItem>
                        <MudSelectItem Value="@("LINQ")">C# LINQ</MudSelectItem>
                    </MudSelect>

                    <MudPaper Class="pa-3" Style="min-height:300px; font-family:monospace; white-space:pre-wrap; background:#1e1e1e; color:#d4d4d4; overflow:auto;">
                        @queryText
                    </MudPaper>
                    
                    <MudStack Direction="Row" Spacing="2" Class="mt-3">
                        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.ContentCopy" OnClick="CopyQuery">Copy</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveQuery">Save</MudButton>
                        <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="RunQuery" Disabled="@(targetStyle != "SQL")">Run (SQL Only)</MudButton>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    [Parameter] public string? ProjectId { get; set; }
    [Parameter] public string? QueryId { get; set; }
    [Inject] IDialogService DialogService { get; set; } = default!;
    [Inject] ISnackbar Snackbar { get; set; } = default!;

    class QueryState
    {
        public string MainTable { get; set; } = "";
        public List<string> SelectedFields { get; set; } = new();
        public List<JoinDef> Joins { get; set; } = new();
        public FilterGroup RootFilterGroup { get; set; } = new FilterGroup { Logic = "AND" };
    }

    class JoinDef { public string Table { get; set; } = ""; public string Type { get; set; } = "INNER"; public string OnLeft { get; set; } = ""; public string OnRight { get; set; } = ""; }
    
    class FilterGroup 
    { 
        public string Logic { get; set; } = "AND"; // AND, OR
        public List<FilterDef> Conditions { get; set; } = new();
        public List<FilterGroup> SubGroups { get; set; } = new();
    }

    class FilterDef 
    { 
        public string Field { get; set; } = ""; 
        public string Operator { get; set; } = "="; 
        public string Value { get; set; } = ""; 
    }

    QueryState state = new();
    List<EntityDto> entities = new();
    string targetStyle = "SQL";
    string queryText = "";
    private HubConnection? hub;
    
    // Helper to check if all main-table fields are selected
    bool IsAllSelected => !string.IsNullOrEmpty(state.MainTable) &&
                          GetFields(state.MainTable).Any() &&
                          state.SelectedFields.Count(s => s.StartsWith(state.MainTable + ".")) == GetFields(state.MainTable).Count();

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(ProjectId))
        {
            await LoadEntities();
            
            if (!string.IsNullOrEmpty(QueryId))
            {
                await LoadQuery();
            }

            // SignalR
            hub = new HubConnectionBuilder()
                .WithUrl(Nav.ToAbsoluteUri("/hubs/notifications"))
                .WithAutomaticReconnect()
                .Build();

            hub.On<Guid>("ProjectUpdated", async (Guid id) =>
            {
                if (id.ToString() == ProjectId)
                {
                    await LoadEntities();
                    StateHasChanged();
                }
            });

            try { await hub.StartAsync(); } catch {}
        }
    }

    async Task LoadQuery()
    {
        try
        {
            var q = await Http.GetFromJsonAsync<CustomQueryDto>($"api/projects/{ProjectId}/queries/{QueryId}");
            if (q != null && !string.IsNullOrEmpty(q.ResultSchema))
            {
                state = JsonSerializer.Deserialize<QueryState>(q.ResultSchema) ?? new();
                UpdateQueryText();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load query: " + ex.Message, Severity.Error);
        }
    }

    async Task LoadEntities()
    {
        try
        {
            entities = await Http.GetFromJsonAsync<List<EntityDto>>($"api/projects/{ProjectId}/entities") ?? new();
        }
        catch
        {
            // handle error
        }
    }

    IEnumerable<FieldDto> GetFields(string tableName)
    {
        return entities.FirstOrDefault(e => e.Name == tableName)?.Fields ?? Enumerable.Empty<FieldDto>();
    }

    void OnMainTableChanged(string val)
    {
        state.MainTable = val;
        state.SelectedFields.Clear();
        UpdateQueryText();
    }

    void OnSelectAllChanged(bool isChecked)
    {
        if (string.IsNullOrEmpty(state.MainTable)) return;
        
        var fields = GetFields(state.MainTable).Select(f => $"{state.MainTable}.{f.Name}").ToList();
        if (isChecked)
        {
            // Add any missing main-table fields
            foreach (var f in fields)
                if (!state.SelectedFields.Contains(f)) state.SelectedFields.Add(f);
        }
        else
        {
            // Remove only main-table fields
            state.SelectedFields.RemoveAll(s => s.StartsWith(state.MainTable + "."));
        }
        UpdateQueryText();
    }

    void OnFieldCheck(string fieldName, bool isChecked)
    {
        if (isChecked && !state.SelectedFields.Contains(fieldName))
            state.SelectedFields.Add(fieldName);
        else if (!isChecked && state.SelectedFields.Contains(fieldName))
            state.SelectedFields.Remove(fieldName);
        
        UpdateQueryText();
    }

    void AddJoin() { state.Joins.Add(new JoinDef()); UpdateQueryText(); }
    void RemoveJoin(JoinDef j) { state.Joins.Remove(j); UpdateQueryText(); }
    
    void AddFilterToGroup(FilterGroup group) { group.Conditions.Add(new FilterDef()); UpdateQueryText(); }
    void RemoveFilterFromGroup(FilterGroup group, FilterDef f) { group.Conditions.Remove(f); UpdateQueryText(); }
    
    void AddSubGroup(FilterGroup parent) { parent.SubGroups.Add(new FilterGroup()); UpdateQueryText(); }
    void RemoveSubGroup(FilterGroup parent, FilterGroup sub) { parent.SubGroups.Remove(sub); UpdateQueryText(); }
    
    void ToggleGroupLogic(FilterGroup group) 
    { 
        group.Logic = group.Logic == "AND" ? "OR" : "AND"; 
        UpdateQueryText(); 
    }

    void OnStyleChanged(string s) { targetStyle = s; UpdateQueryText(); }

    RenderFragment RenderFilterGroup(FilterGroup group, FilterGroup? parent = null) => builder =>
    {
        builder.OpenElement(0, "div");
        builder.AddAttribute(1, "class", "filter-group pl-3 py-2 my-1");
        builder.AddAttribute(2, "style", "border-left: 3px solid " + (group.Logic == "AND" ? "#1E88E5" : "#E53935") + "; background: rgba(255,255,255,0.05);");
        
        // Header
        builder.OpenComponent<MudStack>(3);
        builder.AddAttribute(4, "Direction", "Row");
        builder.AddAttribute(5, "AlignItems", AlignItems.Center);
        builder.AddAttribute(6, "Class", "mb-2");
        builder.AddAttribute(7, "ChildContent", (RenderFragment)((b2) => {
            b2.OpenComponent<MudChip<string>>(8);
            b2.AddAttribute(9, "Label", true);
            b2.AddAttribute(10, "Color", group.Logic == "AND" ? Color.Primary : Color.Error);
            b2.AddAttribute(11, "OnClick", EventCallback.Factory.Create(this, () => ToggleGroupLogic(group)));
            b2.AddAttribute(12, "ChildContent", (RenderFragment)((b3) => b3.AddContent(13, group.Logic)));
            b2.CloseComponent(); // MudChip

            b2.OpenComponent<MudIconButton>(14);
            b2.AddAttribute(15, "Icon", Icons.Material.Filled.Add);
            b2.AddAttribute(16, "Size", Size.Small);
            b2.AddAttribute(17, "Title", "Add Condition");
            b2.AddAttribute(18, "OnClick", EventCallback.Factory.Create(this, () => AddFilterToGroup(group)));
            b2.CloseComponent();

            b2.OpenComponent<MudIconButton>(19);
            b2.AddAttribute(20, "Icon", Icons.Material.Filled.CreateNewFolder);
            b2.AddAttribute(21, "Size", Size.Small);
            b2.AddAttribute(22, "Title", "Add Group");
            b2.AddAttribute(23, "OnClick", EventCallback.Factory.Create(this, () => AddSubGroup(group)));
            b2.CloseComponent();

            if (parent != null)
            {
                b2.OpenComponent<MudIconButton>(24);
                b2.AddAttribute(25, "Icon", Icons.Material.Filled.Delete);
                b2.AddAttribute(26, "Size", Size.Small);
                b2.AddAttribute(27, "Color", Color.Error);
                b2.AddAttribute(28, "OnClick", EventCallback.Factory.Create(this, () => RemoveSubGroup(parent, group)));
                b2.CloseComponent();
            }
        }));
        builder.CloseComponent(); // MudStack

        // Conditions
        foreach (var cond in group.Conditions)
        {
            builder.OpenComponent<MudGrid>(30);
            builder.AddAttribute(31, "Class", "align-center mb-1");
            builder.AddAttribute(32, "ChildContent", (RenderFragment)((b2) => {
                b2.OpenComponent<MudItem>(33);
                b2.AddAttribute(34, "xs", 4);
                b2.AddAttribute(35, "ChildContent", (RenderFragment)((b3) => {
                    b3.OpenComponent<MudAutocomplete<string>>(36);
                    b3.AddAttribute(37, "Value", cond.Field);
                    b3.AddAttribute(38, "ValueChanged", EventCallback.Factory.Create<string>(this, (v) => { cond.Field = v; UpdateQueryText(); }));
                    b3.AddAttribute(39, "Label", "Field");
                    b3.AddAttribute(40, "SearchFunc", new Func<string, Task<IEnumerable<string>>>(SearchFields));
                    b3.AddAttribute(41, "Dense", true);
                    b3.AddAttribute(42, "Margin", Margin.Dense);
                    b3.AddAttribute(43, "Variant", Variant.Outlined);
                    b3.AddAttribute(44, "CoerceText", true);
                    b3.CloseComponent();
                }));
                b2.CloseComponent();

                b2.OpenComponent<MudItem>(43);
                b2.AddAttribute(44, "xs", 3);
                b2.AddAttribute(45, "ChildContent", (RenderFragment)((b3) => {
                    b3.OpenComponent<MudSelect<string>>(46);
                    b3.AddAttribute(47, "Value", cond.Operator);
                    b3.AddAttribute(48, "ValueChanged", EventCallback.Factory.Create<string>(this, (v) => { cond.Operator = v; UpdateQueryText(); }));
                    b3.AddAttribute(49, "Dense", true);
                    b3.AddAttribute(50, "Margin", Margin.Dense);
                    b3.AddAttribute(51, "Variant", Variant.Outlined);
                    b3.AddAttribute(52, "ChildContent", (RenderFragment)((b4) => {
                        foreach(var op in new[] { "=", ">", "<", ">=", "<=", "!=", "LIKE", "IN" }) {
                             b4.OpenComponent<MudSelectItem<string>>(53);
                             b4.AddAttribute(54, "Value", op);
                             b4.AddAttribute(55, "ChildContent", (RenderFragment)((b5) => b5.AddContent(56, op)));
                             b4.CloseComponent();
                        }
                    }));
                    b3.CloseComponent();
                }));
                b2.CloseComponent();

                b2.OpenComponent<MudItem>(57);
                b2.AddAttribute(58, "xs", 4);
                b2.AddAttribute(59, "ChildContent", (RenderFragment)((b3) => {
                    b3.OpenComponent<MudTextField<string>>(60);
                    b3.AddAttribute(61, "Value", cond.Value);
                    b3.AddAttribute(62, "ValueChanged", EventCallback.Factory.Create<string>(this, (v) => { cond.Value = v; UpdateQueryText(); }));
                    b3.AddAttribute(63, "Label", "Value");
                    b3.AddAttribute(64, "Dense", true);
                    b3.AddAttribute(65, "Margin", Margin.Dense);
                    b3.AddAttribute(66, "Variant", Variant.Outlined);
                    b3.CloseComponent();
                }));
                b2.CloseComponent();

                b2.OpenComponent<MudItem>(67);
                b2.AddAttribute(68, "xs", 1);
                b2.AddAttribute(69, "ChildContent", (RenderFragment)((b3) => {
                    b3.OpenComponent<MudIconButton>(70);
                    b3.AddAttribute(71, "Icon", Icons.Material.Filled.Remove);
                    b3.AddAttribute(72, "Size", Size.Small);
                    b3.AddAttribute(73, "Color", Color.Error);
                    b3.AddAttribute(74, "OnClick", EventCallback.Factory.Create(this, () => RemoveFilterFromGroup(group, cond)));
                    b3.CloseComponent();
                }));
                b2.CloseComponent();
            }));
            builder.CloseComponent(); // MudGrid
        }

        // SubGroups
        foreach (var sub in group.SubGroups)
        {
            builder.AddContent(80, RenderFilterGroup(sub, group));
        }

        builder.CloseElement(); // div
    };

    void UpdateQueryText()
    {
        if (string.IsNullOrEmpty(state.MainTable)) { queryText = ""; return; }

        var fields = state.SelectedFields.Any() ? string.Join(", ", state.SelectedFields.Select(f => FormatField(f, targetStyle))) : "*";
        
        if (targetStyle == "SQL")
        {
            var sb = new System.Text.StringBuilder();
            sb.AppendLine($"SELECT {fields}");
            sb.AppendLine($"FROM {state.MainTable}");
            
            foreach (var j in state.Joins)
            {
                if (!string.IsNullOrEmpty(j.Table))
                    sb.AppendLine($"{j.Type} JOIN {j.Table} ON {FormatField(j.OnLeft, "SQL")} = {FormatField(j.OnRight, "SQL")}");
            }

            var whereClause = BuildSqlFilter(state.RootFilterGroup);
            if (!string.IsNullOrWhiteSpace(whereClause))
            {
                sb.AppendLine("WHERE");
                sb.AppendLine(whereClause);
            }
            
            queryText = sb.ToString();
        }
        else if (targetStyle == "MongoDB")
        {
            var sb = new System.Text.StringBuilder();
            sb.Append($"db.{state.MainTable.ToLower()}.aggregate([");
            
            foreach (var j in state.Joins)
            {
                var left = j.OnLeft;
                var right = j.OnRight;
                // derive local/foreign fields
                var leftCol = left.Contains('.') ? left.Split('.')[1] : left;
                var rightCol = right.Contains('.') ? right.Split('.')[1] : right;
                sb.Append($"\n  {{ $lookup: {{ from: '{j.Table.ToLower()}', localField: '{leftCol}', foreignField: '{rightCol}', as: '{j.Table.ToLower()}_docs' }} }},");
            }

            var matchClause = BuildMongoFilter(state.RootFilterGroup);
            if (!string.IsNullOrWhiteSpace(matchClause) && matchClause != "{}")
            {
                sb.Append($"\n  {{ $match: {matchClause} }},");
            }
            
            if (state.SelectedFields.Any())
            {
                 sb.Append("\n  { $project: {");
                 sb.Append(string.Join(", ", state.SelectedFields.Select(f => $"'{FormatField(f, "MongoDB")}': 1")));
                 sb.Append(" } }");
            }

            sb.Append("\n])");
            queryText = sb.ToString();
        }
        else if (targetStyle == "LINQ")
        {
             var sb = new System.Text.StringBuilder();
             sb.Append($"_context.{state.MainTable}");
             
             foreach (var j in state.Joins)
             {
                 sb.Append($"\n    .Include(x => x.{j.Table})"); 
             }

             var whereClause = BuildLinqFilter(state.RootFilterGroup);
             if (!string.IsNullOrWhiteSpace(whereClause))
             {
                 sb.Append($"\n    .Where(x => {whereClause})");
             }

             if (state.SelectedFields.Any())
             {
                 sb.Append($"\n    .Select(x => new {{ {string.Join(", ", state.SelectedFields.Select(f => FormatField(f, "LINQ")))} }})");
             }
             else
             {
                 sb.Append("\n    .ToList()");
             }

             queryText = sb.ToString();
        }
    }

    string BuildSqlFilter(FilterGroup group)
    {
        var parts = new List<string>();
        foreach (var c in group.Conditions)
        {
            if (string.IsNullOrWhiteSpace(c.Field)) continue;
            var field = FormatField(c.Field, "SQL");
            var val = c.Operator == "IN" ? $"({c.Value})" : (IsNumeric(c.Value) ? c.Value : $"'{c.Value}'");
            parts.Add($"{field} {c.Operator} {val}");
        }
        
        foreach (var g in group.SubGroups)
        {
            var sub = BuildSqlFilter(g);
            if (!string.IsNullOrWhiteSpace(sub)) parts.Add($"({sub})");
        }
        
        if (!parts.Any()) return "";
        return string.Join($" {group.Logic} ", parts);
    }

    string BuildMongoFilter(FilterGroup group)
    {
        var parts = new List<string>();
        foreach (var c in group.Conditions)
        {
            if (string.IsNullOrWhiteSpace(c.Field)) continue;
            var field = FormatField(c.Field, "MongoDB");
            var val = IsNumeric(c.Value) ? c.Value : $"'{c.Value}'";
            
            if (c.Operator == "=") parts.Add($"{{ '{field}': {val} }}");
            else if (c.Operator == ">") parts.Add($"{{ '{field}': {{ $gt: {val} }} }}");
            else if (c.Operator == "<") parts.Add($"{{ '{field}': {{ $lt: {val} }} }}");
            else if (c.Operator == ">=") parts.Add($"{{ '{field}': {{ $gte: {val} }} }}");
            else if (c.Operator == "<=") parts.Add($"{{ '{field}': {{ $lte: {val} }} }}");
            else if (c.Operator == "!=") parts.Add($"{{ '{field}': {{ $ne: {val} }} }}");
            // Basic approximation
        }

        foreach (var g in group.SubGroups)
        {
            var sub = BuildMongoFilter(g);
            if (!string.IsNullOrWhiteSpace(sub) && sub != "{}") parts.Add(sub);
        }

        if (!parts.Any()) return "{}";
        if (parts.Count == 1) return parts[0];
        
        var op = group.Logic == "AND" ? "$and" : "$or";
        return $"{{ {op}: [{string.Join(", ", parts)}] }}";
    }

    string BuildLinqFilter(FilterGroup group)
    {
        var parts = new List<string>();
        foreach (var c in group.Conditions)
        {
            if (string.IsNullOrWhiteSpace(c.Field)) continue;
            var op = c.Operator == "=" ? "==" : c.Operator;
            var val = IsNumeric(c.Value) ? c.Value : $"\"{c.Value}\"";
            var field = FormatField(c.Field, "LINQ");
            parts.Add($"{field} {op} {val}");
        }

        foreach (var g in group.SubGroups)
        {
            var sub = BuildLinqFilter(g);
            if (!string.IsNullOrWhiteSpace(sub)) parts.Add($"({sub})");
        }

        if (!parts.Any()) return "";
        var logic = group.Logic == "AND" ? " && " : " || ";
        return string.Join(logic, parts);
    }

    bool IsNumeric(string val) => double.TryParse(val, out _);

    async Task RunQuery()
    {
        // ... (Run logic mostly same, sending SQL to API)
        try {
            var response = await Http.PostAsJsonAsync("api/Query/execute", new QueryDto { Sql = queryText });
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadAsStringAsync();
                // For now just show success or log
                // Ideally show result in a table
            }
        } catch {}
    }
    
    async Task SaveQuery()
    {
        if (string.IsNullOrEmpty(ProjectId)) return;

        var parameters = new DialogParameters();
        parameters.Add("ContentText", "Enter a name for this query:");
        parameters.Add("ButtonText", "Save");
        parameters.Add("Color", Color.Primary);

        var dialog = DialogService.Show<ArchoCybo.Shared.Dialogs.PromptDialog>("Save Query", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string name && !string.IsNullOrWhiteSpace(name))
        {
             try
             {
                 var json = JsonSerializer.Serialize(state);
                 var dto = new CreateCustomQueryDto(name, queryText, json, Guid.Parse(ProjectId));
                 var resp = await Http.PostAsJsonAsync($"api/projects/{ProjectId}/queries", dto);
                 if (resp.IsSuccessStatusCode)
                 {
                     Snackbar.Add("Query saved successfully", Severity.Success);
                 }
                 else
                 {
                     Snackbar.Add("Failed to save query", Severity.Error);
                 }
             }
             catch (Exception ex)
             {
                 Snackbar.Add($"Error: {ex.Message}", Severity.Error);
             }
        }
    }

    async Task CopyQuery()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", queryText);
    }

    // --- Helpers for Field Selection ---

    IEnumerable<string> GetTableFields(string tableName)
    {
        var entity = entities.FirstOrDefault(e => e.Name == tableName);
        if (entity == null) return Enumerable.Empty<string>();
        return entity.Fields.Select(f => $"{tableName}.{f.Name}");
    }

    IEnumerable<string> GetAllScopeFields()
    {
        if (string.IsNullOrEmpty(state.MainTable)) return Enumerable.Empty<string>();
        
        var list = new List<string>();
        list.AddRange(GetTableFields(state.MainTable));
        
        foreach (var j in state.Joins)
        {
            if (!string.IsNullOrEmpty(j.Table))
                list.AddRange(GetTableFields(j.Table));
        }
        return list;
    }

    private Task<IEnumerable<string>> SearchFields(string value)
    {
        var all = GetAllScopeFields();
        if (string.IsNullOrEmpty(value)) return Task.FromResult(all);
        return Task.FromResult(all.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    private Task<IEnumerable<string>> SearchSpecificTableFields(string tableName, string value)
    {
        var fields = GetTableFields(tableName);
        if (string.IsNullOrEmpty(value)) return Task.FromResult(fields);
        return Task.FromResult(fields.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)));
    }

    string FormatField(string field, string style)
    {
        if (string.IsNullOrEmpty(field)) return "";
        
        // Handle simple field names (legacy or Main table implicit)
        if (!field.Contains("."))
        {
             if (style == "LINQ") return $"x.{field}";
             return field;
        }

        var parts = field.Split('.');
        var table = parts[0];
        var col = parts[1];
        
        if (style == "SQL") return field;
        
        if (style == "MongoDB")
        {
            if (table == state.MainTable) return col;
            return $"{table.ToLower()}_docs.{col}";
        }
        
        if (style == "LINQ")
        {
             if (table == state.MainTable) return $"x.{col}";
             return $"x.{table}.{col}";
        }
        
        return field;
    }
}
