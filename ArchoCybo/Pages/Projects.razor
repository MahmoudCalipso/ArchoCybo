@page "/projects"
@using System.Net.Http.Json
@using System.Text.Json
@using System.Net.Http.Headers
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@using MudBlazor.Services
@using ArchoCybo.Application.DTOs
@using ArchoCybo.Shared
@using ArchoCybo.Services
@inject HttpClient Http
@inject NavigationManager Nav
@inject TokenProvider TokenProvider
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Large">
  <MudStack Direction="Row" Justify="Space-between" AlignItems="Center">
    <MudText Typo="Typo.h4">Projects</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreate">New Project</MudButton>
  </MudStack>

  <MudPaper Class="pa-4 mt-4">
    <MudTable Items="projects" Dense="true" Hover="true">
      <ToolBarContent>
        <MudTextField Placeholder="Search..." Adornment="Adornment.Start" AdornmentIcon="Icons.Material.Filled.Search" Value="@search" ValueChanged="@(v => { search = v; Refresh(); })" Immediate="true" />
      </ToolBarContent>
      <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Database</MudTh>
        <MudTh>Status</MudTh>
        <MudTh>Created</MudTh>
        <MudTh></MudTh>
      </HeaderContent>
      <RowTemplate Context="project">
        <MudTd>@project.Name</MudTd>
        <MudTd>@project.DatabaseType</MudTd>
        <MudTd>@project.Status</MudTd>
        <MudTd>@project.CreatedAt.ToLocalTime().ToString("g")</MudTd>
        <MudTd>
          <MudButton Size="Size.Small" Variant="Variant.Outlined" OnClick="() => ShowDetails(project)">Details</MudButton>
          <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Info" Class="ml-2" OnClick="() => GenerateProject(project.Id)">Generate</MudButton>
        </MudTd>
      </RowTemplate>
    </MudTable>

    <MudStack Direction="Row" AlignItems="Center" Justify="Space-between" Class="mt-2">
      <MudText Typo="Typo.caption">Showing @(((page-1)*pageSize)+1)-@(((page-1)*pageSize)+projects.Count) of @totalCount</MudText>
      <MudStack Direction="Row" Spacing="1">
        <MudButton Disabled="@(page==1)" OnClick="PreviousPage">Previous</MudButton>
        <MudButton Disabled="@(((page)*pageSize>=totalCount))" OnClick="NextPage">Next</MudButton>
      </MudStack>
    </MudStack>
  </MudPaper>

  @if (selected != null)
  {
    <MudPaper Class="pa-4 mt-3">
      <MudText Typo="Typo.h6">Project Details</MudText>
      <MudDivider Class="my-2" />
      <MudGrid>
        <MudItem xs="12" md="6">
          <MudText><b>Name:</b> @selected.Name</MudText>
          <MudText><b>Database:</b> @selected.DatabaseType</MudText>
          <MudText><b>Status:</b> @selected.Status</MudText>
        </MudItem>
        <MudItem xs="12" md="6">
          <MudText><b>Created:</b> @selected.CreatedAt.ToLocalTime().ToString("g")</MudText>
          <MudText><b>Generated At:</b> @(selected.GeneratedAt.HasValue ? selected.GeneratedAt.Value.ToLocalTime().ToString("g") : "-")</MudText>
        </MudItem>
        <MudItem xs="12" Class="mt-2">
          <MudButton Variant="Variant.Outlined" OnClick="OpenEdit">Edit</MudButton>
          <MudButton Variant="Variant.Filled" Color="Color.Error" Class="ml-2" OnClick="ConfirmDelete">Delete</MudButton>
          @if (!string.IsNullOrEmpty(artifactUrl))
          {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="@artifactUrl" Class="ml-2">Download Artifact</MudButton>
          }
        </MudItem>
      </MudGrid>
    </MudPaper>
  }
</MudContainer>

@code {
    string search = string.Empty;
    int page = 1;
    int pageSize = 10;
    int totalCount = 0;

    List<ProjectListItem> projects = new();
    ProjectListItem? selected;

    string? artifactUrl;

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
    }

    async Task LoadProjects()
    {
        try
        {
            AttachTokenIfNeeded();
            var res = await Http.GetFromJsonAsync<PagedResult<ProjectListItemDto>>(Nav.ToAbsoluteUri($"api/project/paged?page={page}&pageSize={pageSize}&q={Uri.EscapeDataString(search)}"));
            if (res != null)
            {
                projects = res.Items.Select(x => new ProjectListItem { Id = x.Id, Name = x.Name, DatabaseType = x.DatabaseType.ToString(), Status = x.Status.ToString(), CreatedAt = x.CreatedAt }).ToList();
                totalCount = res.TotalCount;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load projects: " + ex.Message, MudBlazor.Severity.Error);
            projects = new List<ProjectListItem>();
            totalCount = 0;
        }
    }

    void AttachTokenIfNeeded()
    {
        if (!string.IsNullOrEmpty(TokenProvider.Token)) Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenProvider.Token);
        else Http.DefaultRequestHeaders.Authorization = null;
    }

    void OpenCreate()
    {
        var options = new MudBlazor.DialogOptions { CloseButton = true, MaxWidth = MudBlazor.MaxWidth.Small };
        var parameters = new MudBlazor.DialogParameters { { "Model", new Shared.Dialogs.CreateEditProjectDialog.CreateProjectModel() } };
        var dlg = DialogService.Show<Shared.Dialogs.CreateEditProjectDialog>("New Project", parameters, options);
        _ = dlg.Result.ContinueWith(async t => { if (!t.IsFaulted && t.Result.Data is true) await LoadProjects(); });
    }

    void ShowDetails(ProjectListItem p)
    {
        selected = p;
        artifactUrl = null;
    }

    void OpenEdit()
    {
        if (selected == null) return;
        var options = new MudBlazor.DialogOptions { CloseButton = true, MaxWidth = MudBlazor.MaxWidth.Small };
        var parameters = new MudBlazor.DialogParameters { { "Model", new Shared.Dialogs.CreateEditProjectDialog.CreateProjectModel { Name = selected.Name, Description = selected.Description, DatabaseType = Enum.Parse<Shared.Dialogs.CreateEditProjectDialog.DatabaseType>(selected.DatabaseType) } } };
        var dlg = DialogService.Show<Shared.Dialogs.CreateEditProjectDialog>("Edit Project", parameters, options);
        _ = dlg.Result.ContinueWith(async t => { if (!t.IsFaulted && t.Result.Data is true) await LoadProjects(); });
    }

    async Task GenerateProject(Guid id)
    {
        try
        {
            AttachTokenIfNeeded();
            var resp = await Http.PostAsync(Nav.ToAbsoluteUri($"api/generation/{id}/generate"), null);
            if (resp.IsSuccessStatusCode || resp.StatusCode == System.Net.HttpStatusCode.Accepted)
            {
                Snackbar.Add("Generation started", MudBlazor.Severity.Success);
                await LoadProjects();
            }
            else
            {
                var t = await resp.Content.ReadAsStringAsync();
                Snackbar.Add("Failed to start generation: " + t, MudBlazor.Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error starting generation: " + ex.Message, MudBlazor.Severity.Error);
        }
    }

    async Task ConfirmDelete()
    {
        if (selected == null) return;
        var parameters = new MudBlazor.DialogParameters { { "ContentText", $"Are you sure you want to delete '{selected.Name}'?" }, { "ButtonText", "Delete" }, { "Color", Color.Error } };
        var options = new MudBlazor.DialogOptions { CloseButton = true };
        var dlg = DialogService.Show<DialogConfirm>("Confirm", parameters, options);
        var result = await dlg.Result;
        if (!result.Cancelled)
        {
            await DeleteSelected();
        }
    }

    async Task DeleteSelected()
    {
        if (selected == null) return;
        try
        {
            AttachTokenIfNeeded();
            var resp = await Http.DeleteAsync(Nav.ToAbsoluteUri($"api/project/{selected.Id}"));
            if (resp.IsSuccessStatusCode)
            {
                Snackbar.Add("Project deleted", MudBlazor.Severity.Success);
                selected = null;
                await LoadProjects();
            }
            else
            {
                var t = await resp.Content.ReadAsStringAsync();
                Snackbar.Add("Failed to delete: " + t, MudBlazor.Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error deleting project: " + ex.Message, MudBlazor.Severity.Error);
        }
    }

    void PreviousPage()
    {
        if (page > 1) { page--; Refresh(); }
    }

    void NextPage()
    {
        if ((page)*pageSize < totalCount) { page++; Refresh(); }
    }

    void Refresh()
    {
        _ = LoadProjects();
    }

    // Models
    class ProjectListItem
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string DatabaseType { get; set; } = "";
        public string Status { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public DateTime? GeneratedAt { get; set; }
    }
}
