@page "/projects/{ProjectId:guid}/preview"
@using MudBlazor
@using ArchoCybo.Application.Interfaces.IServices
@using ArchoCybo.Application.Interfaces
@using ArchoCybo.Domain.Entities.CodeGeneration
@using ArchoCybo.Domain.Common
@inject IDockerService DockerService
@inject ISnackbar Snackbar
@namespace ArchoCybo.Pages.Projects

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4 flex-row d-flex align-center justify-space-between" Elevation="2">
                <div>
                    <MudText Typo="Typo.h5">Live Preview: @projectName</MudText>
                    <MudText Typo="Typo.caption">Project ID: @ProjectId</MudText>
                </div>
                <MudStack Direction="Row" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Build" 
                               OnClick="BuildAndRun" 
                               Disabled="@(isOperating || isRunning)">
                        Build & Run
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Error" 
                               StartIcon="@Icons.Material.Filled.Stop" 
                               OnClick="Stop" 
                               Disabled="@(isOperating || !isRunning)">
                        Stop
                    </MudButton>
                    <MudChip T="string" Color="@(isRunning ? Color.Success : Color.Default)">
                        Status: @(isRunning ? "Running" : "Stopped")
                    </MudChip>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0">
                <MudTabPanel Text="Swagger UI" Icon="@Icons.Material.Filled.Api">
                    <div style="height: 700px; background-color: white;">
                        @if (isRunning && !string.IsNullOrEmpty(exposedUrl))
                        {
                            <iframe src="@exposedUrl/swagger" style="width: 100%; height: 100%; border: none;"></iframe>
                        }
                        else
                        {
                            <div class="d-flex flex-column align-center justify-center" style="height: 100%;">
                                <MudIcon Icon="@Icons.Material.Filled.CloudOff" Size="Size.Large" Color="Color.Default" />
                                <MudText Color="Color.Default">Waiting for container to start...</MudText>
                            </div>
                        }
                    </div>
                </MudTabPanel>
                <MudTabPanel Text="Container Logs" Icon="@Icons.Material.Filled.Terminal">
                    <div style="height: 700px; background-color: #1e1e1e; color: #d4d4d4; padding: 12px; font-family: 'Consolas', monospace; overflow-y: auto;">
                        <pre style="white-space: pre-wrap;">@logs</pre>
                    </div>
                </MudTabPanel>
            </MudTabs>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudCard Elevation="2" Style="height: 100%;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Deployment Info</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudList T="string">
                        <MudListItem Icon="@Icons.Material.Filled.Info">
                            <b>Image Tag:</b> @imageTag
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.Code">
                            <b>Container ID:</b> @(string.IsNullOrEmpty(containerId) ? "N/A" : containerId.Substring(0, 12))
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.Link">
                            <b>Port:</b> @(exposedPort == 0 ? "N/A" : exposedPort.ToString())
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.Speed">
                            <b>Health:</b> @containerStatus
                        </MudListItem>
                    </MudList>

                    @if (isOperating)
                    {
                        <div class="mt-4">
                            <MudText Typo="Typo.caption">@operationStatus</MudText>
                            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-1" />
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>
