@page "/project/{ProjectId}"
@attribute [Authorize]
@using System.Net.Http.Json
@using System.Text.Json
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Authorization
@using ArchoCybo.Services
@inject HttpClient Http
@inject NavigationManager Nav
@inject TokenProvider TokenProvider
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS
@inject IConfiguration Config

@code {
    [Parameter]
    public string? ProjectId { get; set; }

    JsonElement? project = null;
    List<JsonElement> entities = new();
    List<JsonElement> queries = new();
}

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid Class="mb-6">
        <MudItem xs="12" md="8">
            @if (project.HasValue)
            {
                <MudText Typo="Typo.h3" Class="mb-1" Style="font-weight:700">@project.Value.GetProperty("name").GetString()</MudText>
                <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                    @project.Value.GetProperty("description").GetString()
                </MudText>
            }
            else
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
        </MudItem>
        <MudItem xs="12" md="4" Class="d-flex justify-end align-center gap-2">
            <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Download" OnClick="DownloadProject" Size="Size.Large" Class="rounded-lg">
                Download
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/my-projects" Size="Size.Large" Class="rounded-lg">
                Back
            </MudButton>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .hover-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
    }
</style>

@code {
    void AttachToken()
    {
        if (!string.IsNullOrEmpty(TokenProvider.Token))
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", TokenProvider.Token);
    }

    async Task LoadProject()
    {
        try
        {
            var projectData = await Http.GetFromJsonAsync<JsonElement>($"api/projects/{ProjectId}");
            project = projectData;
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load project: " + ex.Message, Severity.Error);
        }
    }

    async Task LoadEntities()
    {
        try
        {
            entities = await Http.GetFromJsonAsync<List<JsonElement>>($"api/projects/{ProjectId}/entities");
        }
        catch
        {
            entities = new List<JsonElement>();
        }
    }

    async Task LoadQueries()
    {
        try
        {
            queries = await Http.GetFromJsonAsync<List<JsonElement>>($"api/projects/{ProjectId}/queries");
        }
        catch
        {
            queries = new List<JsonElement>();
        }
    }

    void OpenAddEntityDialog()
    {
        var parameters = new DialogParameters { { "ProjectId", ProjectId } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
        DialogService.Show<ArchoCybo.Shared.Dialogs.AddEntityDialog>("Add Entity", parameters, options);
    }

    void ManageProperties(JsonElement entity)
    {
        var entityId = entity.GetProperty("id").GetString();
        var entityName = entity.GetProperty("name").GetString();
        
        var parameters = new DialogParameters 
        { 
            { "EntityName", entityName },
            { "EntityId", entityId },
            { "ProjectId", ProjectId }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<ArchoCybo.Shared.Dialogs.EditEntityDialog>("Manage Entity", parameters, options);
    }

    void DeleteEntity(JsonElement entity)
    {
        Snackbar.Add("Delete entity feature coming soon", Severity.Info);
    }

    void OpenQueryBuilder()
    {
        Nav.NavigateTo($"/query-builder/{ProjectId}");
    }

    void ViewQuery(JsonElement query)
    {
        var queryId = query.GetProperty("id").GetString();
        Nav.NavigateTo($"/query-builder/{ProjectId}/{queryId}");
    }

    async Task DownloadProject()
    {
        try
        {
            AttachToken();
            var resp = await Http.PostAsync($"api/projects/{ProjectId}/generate", null);

            if (resp.IsSuccessStatusCode)
            {
                var content = await resp.Content.ReadAsByteArrayAsync();
                await using var stream = new MemoryStream(content);
                var streamRef = new DotNetStreamReference(stream);
                await JS.InvokeVoidAsync("downloadFileFromStream", "project-backend.zip", streamRef);
                Snackbar.Add("Project downloaded successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error: " + ex.Message, Severity.Error);
        }
    }

    int GetPropertyCount(string? entityId)
    {
        return 5;
    }

    private Microsoft.AspNetCore.SignalR.Client.HubConnection? hub;

    protected override async Task OnInitializedAsync()
    {
        AttachToken();
        await LoadProject();
        await LoadEntities();
        await LoadQueries();

        // SignalR
        var baseUrl = (Config["ApiBaseUrl"] ?? Nav.BaseUri).TrimEnd('/');
        hub = new Microsoft.AspNetCore.SignalR.Client.HubConnectionBuilder()
            .WithUrl($"{baseUrl}/hubs/notifications")
            .WithAutomaticReconnect()
            .Build();

        hub.On<Guid>("ProjectUpdated", async (Guid id) =>
        {
            if (id.ToString() == ProjectId)
            {
                await LoadEntities();
                await LoadQueries();
                StateHasChanged();
            }
        });

        try { await hub.StartAsync(); } catch {}
    }

    public async ValueTask DisposeAsync()
    {
        if (hub != null)
        {
            try { await hub.DisposeAsync(); } catch { }
        }
    }
}
